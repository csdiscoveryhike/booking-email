<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Discovery Hike â€“ Batch & Payment Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Chart.js (added, nothing removed) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* =========================================================
   DESIGN TOKENS (LIGHT / DARK)
========================================================= */
:root {
  --bg: #f4f6f8;
  --surface: #ffffff;
  --surface-soft: #f8fafc;
  --text: #1f2937;
  --text-muted: #6b7280;
  --border: rgba(229,231,235,0.7);

  --brand-primary: #0f2a44;
  --brand-secondary: #1e4f91;

  --shadow-sm: 0 4px 10px rgba(0,0,0,0.06);
  --shadow-md: 0 6px 14px rgba(0,0,0,0.08);
}

/* DARK MODE (ADMIN PANEL PARITY) */
body.dark {
  --bg: #0b1220;
  --surface: #0f172a;
  --surface-soft: #111c33;
  --text: #e5e7eb;
  --text-muted: #94a3b8;
  --border: rgba(148,163,184,0.18);

  --shadow-sm: 0 4px 10px rgba(0,0,0,0.4);
  --shadow-md: 0 6px 14px rgba(0,0,0,0.5);
}

/* =========================================================
   BASE
========================================================= */
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: var(--bg);
  margin: 0;
  padding: 16px;
  color: var(--text);
  transition: background 0.25s ease, color 0.25s ease;
}

.container {
  max-width: 1300px;
  margin: auto;
}

h1 { margin-bottom: 4px; }
.note {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 14px;
}

/* =========================================================
   HEADER (MATCH ADMIN PANEL)
========================================================= */
.dh-header {
  background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
  border-radius: 14px;
  padding: 16px 20px;
  color: #ffffff;
  margin-bottom: 18px;
  box-shadow: var(--shadow-md);
}

.dh-header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.dh-logo { height: 42px; }

.dh-title {
  font-size: 18px;
  font-weight: 700;
}

.dh-subtitle {
  font-size: 12px;
  opacity: 0.85;
}

/* =========================================================
   FILTER BAR
========================================================= */
.filters {
  background: var(--surface);
  padding: 12px;
  border-radius: 12px;
  display: grid;
  grid-template-columns: 200px 1fr auto;
  gap: 10px;
  margin-bottom: 14px;
  box-shadow: var(--shadow-sm);
}

.filters select,
.filters input,
.filters button {
  padding: 9px 10px;
  font-size: 14px;
  background: var(--surface-soft);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 8px;
}

/* =========================================================
   TABLE (CALM, INTERNAL TOOL)
========================================================= */
table {
  width: 100%;
  border-collapse: collapse;
  background: var(--surface);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: var(--shadow-md);
  margin-bottom: 20px;
  table-layout: fixed; /* prevents jumping */
}

th, td {
  padding: 11px 12px;
  border-bottom: 1px solid var(--border);
  font-size: 13.5px;
  vertical-align: middle;
}

th {
  background: var(--surface-soft);
  font-size: 11.5px;
  font-weight: 700;
  letter-spacing: 0.6px;
  text-transform: uppercase;
  color: var(--text-muted);
  white-space: nowrap;
}

/* Row hover â€“ subtle like admin panel */
tbody tr:hover {
  background: rgba(30,79,145,0.05);
  cursor: pointer;
}

/* =========================================================
   COLUMN ALIGNMENT (BATCH TABLE)
========================================================= */
th:nth-child(1), td:nth-child(1) { text-align: left; font-weight: 600; }
th:nth-child(2), td:nth-child(2) {
  text-align: center;
  font-variant-numeric: tabular-nums;
}
th:nth-child(3), td:nth-child(3),
th:nth-child(4), td:nth-child(4) {
  text-align: center;
  font-variant-numeric: tabular-nums;
}
th:nth-child(5), td:nth-child(5),
th:nth-child(6), td:nth-child(6),
th:nth-child(7), td:nth-child(7) {
  text-align: right;
  font-variant-numeric: tabular-nums;
}
th:nth-child(8), td:nth-child(8) {
  text-align: center;
  width: 120px;
}

/* =========================================================
   STATUS BADGES (STABLE)
========================================================= */
.status-upcoming,
.status-past {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 84px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
}

.status-upcoming {
  background: rgba(4,120,87,0.14);
  color: #10b981;
}

.status-past {
  background: rgba(148,163,184,0.18);
  color: var(--text-muted);
}

/* =========================================================
   PAYMENT STATES
========================================================= */
.pay-ok   { color: #10b981; font-weight: 600; }
.pay-due  { color: #f59e0b; font-weight: 600; }
.pay-warn { color: #ef4444; font-weight: 700; }

/* =========================================================
   HIGH PAX (CONTROLLED)
========================================================= */
.high-pax {
  background: rgba(251,191,36,0.14);
}

/* =========================================================
   BOOKINGS PANEL (DETAIL VIEW)
========================================================= */
.bookings-panel {
  background: var(--surface);
  border-radius: 14px;
  padding: 14px;
  box-shadow: var(--shadow-sm);
  margin-bottom: 20px;
  border-left: 4px solid var(--brand-secondary);
}

.bookings-panel table {
  table-layout: fixed;
}

.bookings-panel th,
.bookings-panel td {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 13px;
}

.bookings-panel td:nth-last-child(-n+4) {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

/* =========================================================
   SECTIONS, CARDS, CHARTS
========================================================= */
.section-title {
  margin: 32px 0 12px;
  font-size: 12.5px;
  font-weight: 700;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  color: var(--text-muted);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
}

.card,
.chart-card {
  background: var(--surface);
  padding: 14px;
  border-radius: 14px;
  box-shadow: var(--shadow-sm);
}

.card strong {
  font-size: 22px;
  display: block;
}

.card span {
  font-size: 13px;
  color: var(--text-muted);
}
.chart-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 18px;
}
.chart-title {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 4px;
}

.chart-desc {
  font-size: 12.5px;
  color: var(--text-muted);
  margin-bottom: 10px;
  line-height: 1.5;
}

canvas { max-height: 320px; }

/* =========================================================
   BUTTONS (ADMIN PARITY)
========================================================= */
button {
  background: linear-gradient(135deg, var(--brand-secondary), var(--brand-primary));
  color: white;
  border: none;
  border-radius: 10px;
  padding: 9px 14px;
}

button:hover { opacity: 0.9; }

/* =========================================================
   MOBILE
========================================================= */
@media (max-width: 800px) {
  table thead { display: none; }
  table tr { display: block; }
  table td {
    display: flex;
    justify-content: space-between;
    padding: 8px 10px;
  }
  table td::before {
    content: attr(data-label);
    font-weight: 600;
    color: var(--text-muted);
  }
}
</style>


</head>

<body>
<div class="container">

  <!-- PREMIUM HEADER -->
<div class="dh-header">
  <div class="dh-header-left">
    <!-- keep your logo here -->
    <img src="https://i.imgur.com/40sl7Sv.png" alt="Discovery Hike" class="dh-logo">
    <div>
      <div class="dh-title">Discovery Hike</div>
      <div class="dh-subtitle">Operations Â· Batch Â· Payments Â· Insights</div>
    </div>
  </div>
</div>


<!-- ===== YOUR ORIGINAL HTML (UNCHANGED) ===== -->
<div class="filters">
  <select id="dateFilter">
    <option value="upcoming">Upcoming Batches (from tomorrow)</option>
    <option value="past">Past Batches (incl. today)</option>
    <option value="all">All Batches</option>
  </select>
  <input type="text" id="searchInput" placeholder="Search trek name..." />
  <button onclick="exportCSV()">Export CSV</button>
</div>

<table id="batchTable">
<thead>
<tr>
  <th>Trek</th>
  <th>Date</th>
  <th>Bookings</th>
  <th>Pax</th>
  <th>Turnover</th>
  <th>Advance</th>
  <th>Remaining</th>
  <th>Status</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="bookings-panel" id="bookingsPanel" style="display:none;">
  <h3 id="bookingsTitle"></h3>
  <table id="bookingTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<!-- ===== HISTORICAL INDEXES (NEW) ===== -->
<div class="section-title">ðŸ“Š Historical Indexes (All-time)</div>
<div class="grid">
  <div class="card"><strong id="idxBatches">0</strong><span>Total Batches</span></div>
  <div class="card"><strong id="idxPax">0</strong><span>Total Pax Served</span></div>
  <div class="card"><strong id="idxTurn">â‚¹0</strong><span>Total Turnover</span></div>
  <div class="card"><strong id="idxAdv">â‚¹0</strong><span>Total Advance</span></div>
  <div class="card"><strong id="idxOut">â‚¹0</strong><span>Total Outstanding</span></div>
</div>

<div class="section-title">ðŸ“Œ Historical Highlights</div>
<div class="grid">
  <div class="card"><strong id="idxTopTrek">â€“</strong><span>Busiest Trek</span></div>
  <div class="card"><strong id="idxBusyDay">â€“</strong><span>Busiest Day</span></div>
  <div class="card"><strong id="idxBigBatch">â€“</strong><span>Largest Batch</span></div>
</div>

<!-- ===== TRENDS ===== -->
<div class="section-title">ðŸ“ˆ Trends & Insights (All-time)</div>
<div class="chart-grid">

  <div class="chart-card">
    <div class="chart-title">Monthly Pax Trend</div>
    <div class="chart-desc">
      Shows how many participants joined across all batches month-by-month.
      Useful to understand seasonal demand and growth.
    </div>
    <canvas id="paxTrend"></canvas>
  </div>

  <div class="chart-card">
    <div class="chart-title">Monthly Turnover Trend</div>
    <div class="chart-desc">
      Total revenue generated per month from all treks.
      Helps track business performance over time.
    </div>
    <canvas id="turnTrend"></canvas>
  </div>

  <div class="chart-card">
    <div class="chart-title">Advance vs Remaining Payments</div>
    <div class="chart-desc">
      Comparison of money already collected versus outstanding balance,
      stacked month-wise for cash-flow clarity.
    </div>
    <canvas id="advRemTrend"></canvas>
  </div>

  <div class="chart-card">
    <div class="chart-title">Top Treks by Participation</div>
    <div class="chart-desc">
      Highlights treks that attracted the highest number of participants
      across all time.
    </div>
    <canvas id="topTreks"></canvas>
  </div>

  <div class="chart-card">
    <div class="chart-title">Batch Size Distribution</div>
    <div class="chart-desc">
      Number of batches grouped by pax size. Useful to understand
      operational load and planning patterns.
    </div>
    <canvas id="batchLoad"></canvas>
  </div>

</div>


</div>

<script>
/* ===== YOUR ORIGINAL SCRIPT (UNCHANGED, ONLY EXTENDED) ===== */
const DATA_URL = 'https://script.google.com/macros/s/AKfycbz2VgvO8CFo6b-1f02dnnW5s2DDZfv9Ai0U5oiNg6laOStze00NF3TcL0UnOQP6pCsucQ/exec';
const TREK=3, DATE=4, DEAL=5, PAX=6, ADV=7;
const today = new Date(); today.setHours(0,0,0,0);

const norm = s => (s||'').toLowerCase().trim();
const money = n => 'â‚¹'+n.toLocaleString('en-IN');
function formatDate(d){
  const x = new Date(d);
  if (isNaN(x)) return d || '';
  return String(x.getDate()).padStart(2,'0') + '-' +
         String(x.getMonth()+1).padStart(2,'0') + '-' +
         x.getFullYear();
}

let raw=[], headers=[], allBatches=[];

fetch(DATA_URL).then(r=>r.json()).then(d=>{
  headers=d[0];
  raw=d.slice(1);
  allBatches=buildBatches();
  render();
  renderHistorical(allBatches);
  renderCharts(allBatches);
});

function buildBatches(){
  const m={};
  raw.forEach(r=>{
    const key=norm(r[TREK])+'|'+r[DATE];
    if(!m[key]) m[key]={ trek:r[TREK], date:new Date(r[DATE]), rows:[], pax:0, turn:0, adv:0 };
    const pax=Number(r[PAX])||0;
    const deal=Number(r[DEAL])||0;
    const adv=Number(r[ADV])||0;
    m[key].rows.push(r);
    m[key].pax+=pax;
    m[key].turn+=deal*pax;
    m[key].adv+=adv;
  });
  return Object.values(m);
}

/* ===== ORIGINAL render(), showBookings(), exportCSV() UNCHANGED ===== */
function render(){
  const f=dateFilter.value, s=searchInput.value.toLowerCase();
  const current=allBatches.filter(b=>{
    const d=Math.floor((b.date-today)/86400000);
    if(f==='upcoming'&&d<=0) return false;
    if(f==='past'&&d>0) return false;
    if(s&&!b.trek.toLowerCase().includes(s)) return false;
    return true;
  });

  const tb=document.querySelector('#batchTable tbody');
  tb.innerHTML='';
  current.sort((a,b)=>a.date-b.date).forEach(b=>{
    const rem=b.turn-b.adv;
    const tr=document.createElement('tr');
    if(b.pax>=20) tr.classList.add('high-pax');
    tr.innerHTML=`
      <td data-label="Trek">${b.trek}</td>
      <td data-label="Date">${b.date.toLocaleDateString('en-GB')}</td>
      <td data-label="Bookings">${b.rows.length}</td>
      <td data-label="Pax">${b.pax}</td>
      <td data-label="Turnover">${money(b.turn)}</td>
      <td data-label="Advance">${money(b.adv)}</td>
      <td data-label="Remaining">${money(b.turn-b.adv)}</td>
      <td data-label="Status" class="${b.date>today?'status-upcoming':'status-past'}">
        ${b.date>today?'Upcoming':'Past'}
      </td>`;
    tr.onclick=()=>showBookings(b);
    tb.appendChild(tr);
  });
}

function showBookings(b){
  bookingsPanel.style.display='block';
  bookingsTitle.textContent=`${b.trek} â€“ ${b.date.toLocaleDateString('en-GB')}`;
  bookingTable.querySelector('thead').innerHTML =
    `<tr>${headers.map(h=>`<th>${h}</th>`).join('')}
      <th>Total</th><th>Remaining</th></tr>`;
  bookingTable.querySelector('tbody').innerHTML =
    b.rows.map(r=>{
      const total=(+r[DEAL]||0)*(+r[PAX]||0);
      const rem=total-(+r[ADV]||0);
      return `<tr>${r.map((c,i) => {
  if (i === DATE) {
    return `<td>${formatDate(c)}</td>`;
  }
  return `<td>${c || ''}</td>`;
}).join('')
}
        <td>${money(total)}</td><td>${money(rem)}</td></tr>`;
    }).join('');
}

function exportCSV(){
  let csv="Trek,Date,Bookings,Pax,Turnover,Advance,Remaining\n";
  allBatches.forEach(b=>{
    csv+=`${b.trek},${b.date.toLocaleDateString('en-GB')},${b.rows.length},${b.pax},${b.turn},${b.adv},${b.turn-b.adv}\n`;
  });
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='batch-payments.csv';
  a.click();
}

/* ===== NEW: HISTORICAL INDEXES ===== */
function renderHistorical(b){
  let pax=0,turn=0,adv=0;
  const trekMap={},dateMap={};
  b.forEach(x=>{
    pax+=x.pax; turn+=x.turn; adv+=x.adv;
    trekMap[x.trek]=(trekMap[x.trek]||0)+x.pax;
    const d=x.date.toLocaleDateString('en-GB');
    dateMap[d]=(dateMap[d]||0)+x.pax;
  });
  idxBatches.textContent=b.length;
  idxPax.textContent=pax;
  idxTurn.textContent=money(turn);
  idxAdv.textContent=money(adv);
  idxOut.textContent=money(turn-adv);
  idxTopTrek.textContent=Object.entries(trekMap).sort((a,b)=>b[1]-a[1])[0][0];
  idxBusyDay.textContent=Object.entries(dateMap).sort((a,b)=>b[1]-a[1])[0][0];
  idxBigBatch.textContent=b.sort((a,b)=>b.pax-a.pax)[0].trek;
}

/* ===== NEW: CHARTS ===== */
function renderCharts(b){
  const m={},tm={},bk={'1â€“5':0,'6â€“10':0,'11â€“15':0,'16â€“20':0,'20+':0};
  b.forEach(x=>{
    const k=x.date.getFullYear()+'-'+String(x.date.getMonth()+1).padStart(2,'0');
    if(!m[k]) m[k]={pax:0,turn:0,adv:0};
    m[k].pax+=x.pax; m[k].turn+=x.turn; m[k].adv+=x.adv;
    tm[x.trek]=(tm[x.trek]||0)+x.pax;
    if(x.pax<=5)bk['1â€“5']++;else if(x.pax<=10)bk['6â€“10']++;
    else if(x.pax<=15)bk['11â€“15']++;else if(x.pax<=20)bk['16â€“20']++;else bk['20+']++;
  });

  const lbl=Object.keys(m).sort();
  new Chart(paxTrend,{type:'line',data:{labels:lbl,datasets:[{label:'Pax',data:lbl.map(l=>m[l].pax)}]}});
  new Chart(turnTrend,{type:'line',data:{labels:lbl,datasets:[{label:'Turnover',data:lbl.map(l=>m[l].turn)}]}});
  new Chart(advRemTrend,{type:'bar',data:{labels:lbl,datasets:[
    {label:'Advance',data:lbl.map(l=>m[l].adv)},
    {label:'Remaining',data:lbl.map(l=>m[l].turn-m[l].adv)}
  ]},options:{scales:{x:{stacked:true},y:{stacked:true}}}});
  new Chart(topTreks,{type:'bar',data:{labels:Object.keys(tm),datasets:[{label:'Pax',data:Object.values(tm)}]}});
  new Chart(batchLoad,{type:'bar',data:{labels:Object.keys(bk),datasets:[{label:'Batches',data:Object.values(bk)}]}});
}

dateFilter.onchange = searchInput.oninput = render;
</script>

</body>
</html>
